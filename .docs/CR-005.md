# CR-005 — Deposit Target Consistency (Maths + Logic Fix)
## Ensure “Deposit Required” and “Time to Save” always use the same deposit target

**Change Request ID:** CR-005  
**Product:** calc.homeown.ie  
**Status:** Approved for implementation  
**Priority:** High  
**Type:** Logic / Maths / Bucket classification  
**Depends on:** CR-002 (Simplification Pivot)  
**UI Changes:** Minor (labels/copy only where necessary)

---

## 1. Summary

A bug has been identified where the calculator can display a high “deposit % required” (e.g., 40–45%)
while still calculating “time to save” and bucket outcomes using the default 10% deposit target.

This CR ensures there is a **single source of truth** for the deposit target used across:

- Deposit % required
- Deposit required (€)
- Time-to-save calculation
- Bucket assignment

Clamping Target Property Price (TPP) to 5× income is a temporary guardrail; it does **not** fix the underlying logic.
This CR corrects the core model.

---

## 2. Definitions

**TPP** = Target Property Price (today)  
**GHI** = Gross Household Income (annual)  
**currentSavings** = savings today  
**monthlySavings** = savings per month  
**PPA** = Property Price Appreciation (annual %)  
**horizonMonths** = 480 (40 years)  
**depositFloorPercent** = 10% (v1 default deposit floor)

**Rule-of-thumb mortgage multiple** (per product spec):
- `maxMortgage = 4 × GHI`

---

## 3. Required Deposit: Correct Formula (Single Source of Truth)

### 3.1 Required deposit in euro (rule-of-thumb affordability)
```text
requiredDepositEuro_today = max(0, TPP - maxMortgage)
```

### 3.2 Required deposit as a percentage
```text
requiredDepositPercent_today = requiredDepositEuro_today / TPP
```

### 3.3 Deposit percent used for all downstream calculations (v1)
The calculator must use the **higher** of:
- the default deposit floor (10%)
- the affordability-required deposit %

```text
depositPercentUsed = max(depositFloorPercent, requiredDepositPercent_today)
```

Rationale: if income constraints imply a higher deposit is needed, it is misleading to show time-to-save against 10% only.

---

## 4. Time-to-Save Calculation (Must Use depositPercentUsed)

### 4.1 Monthly property growth rate
```text
monthlyGrowth = (1 + PPA)^(1/12) - 1
```

### 4.2 Deposit target over time
```text
depositTarget(t) = depositPercentUsed × TPP × (1 + monthlyGrowth)^t
```

### 4.3 Savings over time
```text
savings(t) = currentSavings + monthlySavings × t
```

### 4.4 Catch condition
Find the earliest month `t` within horizonMonths where:
```text
savings(t) ≥ depositTarget(t)
```

If no such month exists:
- time-to-save = “Not reachable”
- deposit required at catch = “—”
- bucket = “Can’t save” (unless Bucket 4 applies; see Section 5)

---

## 5. Bucket Logic (Updated to Avoid Contradictions)

Buckets must remain deterministic and non-contradictory.

### Bucket 4 — Target looks high vs income (rule-of-thumb)
Trigger when affordability requires a deposit above the floor:

```text
requiredDepositPercent_today > depositFloorPercent
```

If Bucket 4 triggers:
- The UI must label the result as “Rule-of-thumb only”
- The calculator must still compute time-to-save using depositPercentUsed
- If time-to-save is not reachable, the headline should reflect both:
  - “Target looks high vs income (rule-of-thumb)”
  - “Not reachable under current assumptions”

### Bucket 1 — Can’t save deposit
Trigger when:
- time-to-save is not reachable within horizonMonths
AND Bucket 4 is not triggered (or Bucket 4 is triggered but “not reachable” must still be shown clearly)

### Bucket 2 — Will save deposit > 5 years
Trigger when:
- reachable and monthsToSave > 60
AND Bucket 4 not triggered

### Bucket 3 — Will save deposit ≤ 5 years
Trigger when:
- reachable and monthsToSave ≤ 60
AND Bucket 4 not triggered

**Precedence rule:**
- Bucket 4 overrides Buckets 2 and 3
- “Not reachable” status overrides “deposit required at catch” output (set to “—”)

---

## 6. UI Output Requirements (Consistency)

The following must be consistent with depositPercentUsed:

- “Deposit required” (value shown in results)
- “Deposit % used” (if displayed)
- “Time to save”
- Bucket meter selection

When Bucket 4 is active, deposit % required should be shown explicitly (e.g., “Deposit required: 39% (rule-of-thumb)”)

---

## 7. Edge Cases

1) **TPP <= maxMortgage**
- requiredDepositPercent_today = 0
- depositPercentUsed = 10%
- tool behaves as deposit-floor model

2) **monthlySavings = 0**
- if currentSavings < depositTarget(0) then Not reachable

3) **currentSavings already >= depositTarget(0)**
- “Deposit already saved” state (time-to-save not shown as 0 months)

---

## 8. Acceptance Criteria

- For any input combination, the calculator must not show:
  - a high “deposit % required”
  - while simultaneously showing a reachable time-to-save based on 10%
- “Deposit required”, “Deposit % used”, and “Time-to-save” are all derived from depositPercentUsed
- Bucket 4 triggers deterministically when requiredDepositPercent_today > 10%
- The “Not reachable” state behaves correctly within the 40-year horizon
- Unit tests cover:
  - income mismatch scenario (e.g. TPP 800k, GHI 122k, PPA 6%, monthlySavings 2k) -> Not reachable
  - floor-only scenario (TPP <= 4×GHI) -> uses 10%
  - zero savings scenario -> Not reachable

---

## 9. Notes on TPP Clamp (Temporary)

Clamping TPP to 5× income may remain as a UX guardrail,
but it must not be relied on to prevent contradictions.
The model must remain correct even without the clamp.

---

## 10. Definition of Done

- depositPercentUsed implemented as a single source of truth
- time-to-save uses depositPercentUsed deposit target
- outputs and buckets updated for consistency
- unit tests added for mismatch + edge cases
- verified on mobile and desktop
- deployed to calc.homeown.ie
